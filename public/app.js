const API_URL='http://localhost:3000/api';let currentUser=null;let currentCourse=null;let currentChat=null;let currentPost=null;let previousView='dashboard';document.addEventListener('DOMContentLoaded',()=>{checkAuth()});function checkAuth(){const user=localStorage.getItem('currentUser');if(user){currentUser=JSON.parse(user);showMainApp()}else{showAuthScreen()}}function showAuthScreen(){document.getElementById('auth-screen').style.display='flex';document.getElementById('main-app').style.display='none'}function showMainApp(){document.getElementById('auth-screen').style.display='none';document.getElementById('main-app').style.display='flex';initTheme();updateUserInfo();loadDashboard();loadChats();loadNotifications();setInterval(loadChats,5000);setInterval(loadNotifications,30000)}function switchToSignup(){document.getElementById('login-form').classList.remove('active');document.getElementById('signup-form').classList.add('active')}function switchToLogin(){document.getElementById('signup-form').classList.remove('active');document.getElementById('login-form').classList.add('active')}async function handleLogin(e){e.preventDefault();const email=document.getElementById('login-email').value;const password=document.getElementById('login-password').value;try{const response=await fetch(`${API_URL}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});if(response.ok){const data=await response.json();currentUser=data.user;localStorage.setItem('currentUser',JSON.stringify(currentUser));showMainApp()}else{const error=await response.json();alert(error.error||'Login failed')}}catch(err){alert('Login failed: '+err.message)}}async function handleSignup(e){e.preventDefault();const name=document.getElementById('signup-name').value;const email=document.getElementById('signup-email').value;const password=document.getElementById('signup-password').value;const role=document.getElementById('signup-role').value;const level=document.getElementById('signup-level').value;try{const response=await fetch(`${API_URL}/auth/signup`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email,password,role,level})});if(response.ok){const data=await response.json();currentUser=data.user;localStorage.setItem('currentUser',JSON.stringify(currentUser));showMainApp()}else{const error=await response.json();alert(error.error||'Signup failed')}}catch(err){alert('Signup failed: '+err.message)}}function handleLogout(){localStorage.removeItem('currentUser');currentUser=null;showAuthScreen()}function updateUserInfo(){if(!currentUser)return;const initial=currentUser.name.charAt(0).toUpperCase();document.getElementById('sidebar-avatar').textContent=initial;document.getElementById('sidebar-name').textContent=currentUser.name;document.getElementById('sidebar-role').textContent=currentUser.role==='ta'?'TA':currentUser.role;document.getElementById('profile-avatar').textContent=initial;document.getElementById('profile-name').textContent=currentUser.name;document.getElementById('profile-role').textContent=currentUser.role==='ta'?'Teaching Assistant':currentUser.role;document.getElementById('profile-email').textContent=currentUser.email;document.getElementById('profile-level').textContent=currentUser.level||'-';document.getElementById('profile-joined').textContent=new Date(currentUser.createdAt).toLocaleDateString();document.getElementById('profile-courses-count').textContent=currentUser.courses?.length||0;if(currentUser.role==='instructor'){document.getElementById('create-course-btn').style.display='block'}}function switchView(viewName){document.querySelectorAll('.nav-item').forEach(item=>item.classList.remove('active'));document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');document.querySelectorAll('.view').forEach(view=>view.classList.remove('active'));if(viewName==='dashboard'){document.getElementById('dashboard-view').classList.add('active');loadDashboard()}else if(viewName==='my-courses'){document.getElementById('my-courses-view').classList.add('active');loadMyCourses()}else if(viewName==='all-courses'){document.getElementById('all-courses-view').classList.add('active');loadAllCourses()}else if(viewName==='messages'){document.getElementById('messages-view').classList.add('active');loadChats()}else if(viewName==='profile'){document.getElementById('profile-view').classList.add('active');loadProfile()}previousView=viewName}function goBack(){if(currentCourse){switchView('my-courses')}else{switchView(previousView)}}async function loadDashboard(){try{const statsRes=await fetch(`${API_URL}/users/${currentUser._id}/stats`);const stats=await statsRes.json();document.getElementById('enrolled-count').textContent=currentUser.courses?.length||0;document.getElementById('posts-count').textContent=stats.posts||0;document.getElementById('comments-count').textContent=stats.comments||0;document.getElementById('reactions-count').textContent=stats.reactions||0;const coursesRes=await fetch(`${API_URL}/courses?enrolled=${currentUser._id}`);const courses=await coursesRes.json();const recentPosts=document.getElementById('recent-posts');if(courses.length>0){let allPosts=[];for(const course of courses.slice(0,3)){const postsResponse=await fetch(`${API_URL}/courses/${course._id}/posts`);const posts=await postsResponse.json();allPosts=allPosts.concat(posts.slice(0,2))}recentPosts.innerHTML=allPosts.map(post=>`<div class="post-card" onclick="openPostFromDashboard('${post._id}','${post.courseId}')"><div class="post-header"><div class="user-avatar">${post.sender.name.charAt(0)}</div><div class="post-meta"><div class="post-author">${post.sender.name}</div><div class="post-date">${new Date(post.createdAt).toLocaleDateString()}</div></div><span class="post-type ${post.type}">${post.type}</span></div><div class="post-title">${post.title}</div><div class="post-body">${post.body.substring(0,100)}...</div></div>`).join('')}else{recentPosts.innerHTML='<p style="color:var(--gray)">No recent activity. Enroll in courses to get started!</p>'}}catch(err){console.error('Error loading dashboard:',err)}}async function openPostFromDashboard(postId,courseId){const response=await fetch(`${API_URL}/courses/${courseId}`);currentCourse=await response.json();openPost(postId)}async function loadMyCourses(){try{const response=await fetch(`${API_URL}/courses?enrolled=${currentUser._id}`);const courses=await response.json();const list=document.getElementById('my-courses-list');if(courses.length===0){list.innerHTML='<p style="color:var(--gray);grid-column:1/-1;text-align:center;padding:2rem">You are not enrolled in any courses yet. Browse courses to get started!</p>';return}list.innerHTML=courses.map(course=>`<div class="course-card" onclick="openCourse('${course._id}')"><h3>${course.name}</h3><div class="course-code">${course._id}</div><p class="course-description">${course.description}</p><div class="course-meta"><span>üìö ${course.creditHours} Credits</span><div class="course-enrollment"><span>${course.enrolled}/${course.capacity}</span><div class="enrollment-bar"><div class="enrollment-fill" style="width:${(course.enrolled/course.capacity)*100}%"></div></div></div></div></div>`).join('')}catch(err){console.error('Error loading courses:',err)}}async function loadAllCourses(){try{const response=await fetch(`${API_URL}/courses`);const allCourses=await response.json();const list=document.getElementById('all-courses-list');list.innerHTML=allCourses.map(course=>{const isEnrolled=currentUser.courses?.includes(course._id);const isFull=course.enrolled>=course.capacity;return`<div class="course-card"><h3>${course.name}</h3><div class="course-code">${course._id}</div><p class="course-description">${course.description}</p><div class="course-meta"><span>üìö ${course.creditHours} Credits</span><div class="course-enrollment"><span>${course.enrolled}/${course.capacity}</span><div class="enrollment-bar"><div class="enrollment-fill" style="width:${(course.enrolled/course.capacity)*100}%"></div></div></div></div><button class="btn-enroll ${isEnrolled?'btn-unenroll':''}" onclick="${isEnrolled?`unenrollCourse('${course._id}')`:`enrollCourse('${course._id}')`}" ${isFull&&!isEnrolled?'disabled':''}>${isEnrolled?'Unenroll':isFull?'Full':'Enroll'}</button></div>`}).join('')}catch(err){console.error('Error loading courses:',err)}}async function enrollCourse(courseId){try{const response=await fetch(`${API_URL}/courses/${courseId}/enroll`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser._id})});if(response.ok){currentUser.courses.push(courseId);localStorage.setItem('currentUser',JSON.stringify(currentUser));loadAllCourses();loadMyCourses();updateUserInfo()}else{const error=await response.json();alert(error.error)}}catch(err){alert('Enrollment failed: '+err.message)}}async function unenrollCourse(courseId){if(!confirm('Are you sure you want to unenroll from this course?'))return;try{const response=await fetch(`${API_URL}/courses/${courseId}/unenroll`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser._id})});if(response.ok){currentUser.courses=currentUser.courses.filter(c=>c!==courseId);localStorage.setItem('currentUser',JSON.stringify(currentUser));loadAllCourses();loadMyCourses();updateUserInfo()}}catch(err){alert('Unenrollment failed: '+err.message)}}async function openCourse(courseId){try{const response=await fetch(`${API_URL}/courses/${courseId}`);currentCourse=await response.json();document.getElementById('course-title').textContent=currentCourse.name;document.getElementById('course-description').textContent=currentCourse.description;document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById('course-detail-view').classList.add('active');switchCourseTab('posts')}catch(err){console.error('Error opening course:',err)}}function switchCourseTab(tab){document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(content=>content.classList.remove('active'));const tabs=document.querySelectorAll('.tab-btn');if(tab==='posts'){tabs[0].classList.add('active');document.getElementById('course-posts-tab').classList.add('active');loadPosts()}else if(tab==='files'){tabs[1].classList.add('active');document.getElementById('course-files-tab').classList.add('active');loadFiles()}else{tabs[2].classList.add('active');document.getElementById('course-about-tab').classList.add('active');loadCourseAbout()}}function loadFiles(){const uploadCard=document.getElementById('upload-file-card');if(currentUser.role==='instructor'||currentUser.role==='ta'){uploadCard.style.display='block'}else{uploadCard.style.display='none'}const filesList=document.getElementById('files-list');filesList.innerHTML='<div class="file-item"><div class="file-icon">üìÑ</div><div class="file-details"><div class="file-name">Syllabus - '+currentCourse.name+'</div><div class="file-meta">Uploaded by instructor ‚Ä¢ PDF ‚Ä¢ 2.5 MB</div></div><button class="btn-download" onclick="alert(\'Download functionality coming soon!\')">Download</button></div><div class="file-item"><div class="file-icon">üìä</div><div class="file-details"><div class="file-name">Lecture Slides - Week 1</div><div class="file-meta">Uploaded by instructor ‚Ä¢ PPTX ‚Ä¢ 5.2 MB</div></div><button class="btn-download" onclick="alert(\'Download functionality coming soon!\')">Download</button></div>'}function handleImagePreview(input){const preview=document.getElementById('image-preview');preview.innerHTML='';if(input.files&&input.files[0]){const reader=new FileReader();reader.onload=function(e){preview.innerHTML=`<img src="${e.target.result}" alt="Preview">`};reader.readAsDataURL(input.files[0])}}function handleFileSelect(input){const fileInfo=document.getElementById('file-info');if(input.files&&input.files[0]){const file=input.files[0];const sizeMB=(file.size/1024/1024).toFixed(2);fileInfo.innerHTML=`<strong>${file.name}</strong> (${sizeMB} MB)`}else{fileInfo.innerHTML=''}}function uploadFile(){const title=document.getElementById('file-title').value;const fileInput=document.getElementById('course-file');if(!title||!fileInput.files[0]){alert('Please provide a file name and select a file');return}alert('File upload functionality will be implemented with backend storage. File: '+fileInput.files[0].name);document.getElementById('file-title').value='';fileInput.value='';document.getElementById('file-info').innerHTML='';loadFiles()}async function loadPosts(){try{const response=await fetch(`${API_URL}/courses/${currentCourse._id}/posts`);const posts=await response.json();const list=document.getElementById('posts-list');list.innerHTML=posts.map(post=>`<div class="post-card" onclick="openPost('${post._id}')"><div class="post-header"><div class="user-avatar">${post.sender.name.charAt(0)}</div><div class="post-meta"><div class="post-author">${post.sender.name}</div><div class="post-date">${new Date(post.createdAt).toLocaleDateString()}</div></div><span class="post-type ${post.type}">${post.type}</span></div><div class="post-title">${post.title}</div><div class="post-body">${post.body.substring(0,150)}${post.body.length>150?'...':''}</div><div class="post-stats"><span>üí¨ Comments</span><span>üëç Reactions</span>${post.type==='question'?`<span>${post.answered?'‚úÖ Answered':'‚ùì Unanswered'}</span>`:''}</div></div>`).join('')}catch(err){console.error('Error loading posts:',err)}}async function loadCourseAbout(){const content=document.getElementById('course-about-content');try{const instructors=await Promise.all(currentCourse.instructorId.map(id=>fetch(`${API_URL}/users/${id}`).then(r=>r.json())));content.innerHTML=`<div class="profile-card"><h3>Course Information</h3><div class="profile-field"><label>Course Code</label><div>${currentCourse._id}</div></div><div class="profile-field"><label>Credit Hours</label><div>${currentCourse.creditHours}</div></div><div class="profile-field"><label>Enrollment</label><div>${currentCourse.enrolled}/${currentCourse.capacity} students</div></div><div class="profile-field"><label>Instructors</label><div>${instructors.map(i=>i.name).join(', ')}</div></div></div>`}catch(err){console.error('Error loading course about:',err)}}async function createPost(){const title=document.getElementById('post-title').value;const body=document.getElementById('post-body').value;const type=document.getElementById('post-type').value;if(!title||!body){alert('Please fill in all fields');return}try{const response=await fetch(`${API_URL}/posts`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({senderId:currentUser._id,courseId:currentCourse._id,title,body,type})});if(response.ok){document.getElementById('post-title').value='';document.getElementById('post-body').value='';loadPosts()}}catch(err){alert('Failed to create post: '+err.message)}}async function openPost(postId){try{const postsResponse=await fetch(`${API_URL}/courses/${currentCourse._id}/posts`);const posts=await postsResponse.json();currentPost=posts.find(p=>p._id===postId);const detail=document.getElementById('post-detail');detail.innerHTML=`<div class="post-header"><div class="user-avatar">${currentPost.sender.name.charAt(0)}</div><div class="post-meta"><div class="post-author">${currentPost.sender.name}</div><div class="post-date">${new Date(currentPost.createdAt).toLocaleDateString()}</div></div><span class="post-type ${currentPost.type}">${currentPost.type}</span></div><div class="post-title">${currentPost.title}</div><div class="post-body">${currentPost.body}</div>`;document.getElementById('post-modal').classList.add('active');loadComments(postId);loadReactions(postId)}catch(err){console.error('Error opening post:',err)}}function closePostModal(){document.getElementById('post-modal').classList.remove('active')}async function loadComments(postId){try{const response=await fetch(`${API_URL}/posts/${postId}/comments`);const comments=await response.json();const list=document.getElementById('comments-list');list.innerHTML=comments.map(comment=>`<div class="comment"><div class="comment-author">${comment.sender.name}</div><div class="comment-date">${new Date(comment.createdAt).toLocaleString()}</div><div class="comment-body">${comment.body}</div></div>`).join('')}catch(err){console.error('Error loading comments:',err)}}async function loadReactions(postId){try{const response=await fetch(`${API_URL}/posts/${postId}/reactions`);const data=await response.json();const summary=data.summary||{};const reactions=data.reactions||[];const userReaction=reactions.find(r=>r.senderId===currentUser._id);document.querySelectorAll('.reaction-btn').forEach(btn=>{const type=btn.getAttribute('onclick').match(/'([^']+)'/)[1];const count=summary[type]||0;const isReacted=userReaction&&userReaction.type===type;btn.classList.toggle('reacted',isReacted);if(count>0){btn.innerHTML=`${getReactionEmoji(type)} <span class="reaction-count">${count}</span>`}else{btn.innerHTML=getReactionEmoji(type)}})}catch(err){console.error('Error loading reactions:',err)}}function getReactionEmoji(type){const emojis={like:'üëç',love:'‚ù§Ô∏è',shocked:'üòÆ',laugh:'üòÇ',sad:'üò¢'};return emojis[type]||'üëç'}async function addComment(){const body=document.getElementById('comment-body').value;if(!body){alert('Please enter a comment');return}try{const response=await fetch(`${API_URL}/comments`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({postId:currentPost._id,senderId:currentUser._id,body})});if(response.ok){document.getElementById('comment-body').value='';loadComments(currentPost._id)}}catch(err){alert('Failed to add comment: '+err.message)}}async function addReaction(type){try{const response=await fetch(`${API_URL}/reactions`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({postId:currentPost._id,senderId:currentUser._id,type})});if(response.ok){loadReactions(currentPost._id)}}catch(err){console.error('Failed to add reaction:',err)}}async function loadChats(){try{const response=await fetch(`${API_URL}/users/${currentUser._id}/chats`);const chats=await response.json();const list=document.getElementById('chats-list');list.innerHTML=chats.map(chat=>{const otherUser=chat.user1.id===currentUser._id?chat.user2:chat.user1;return`<div class="chat-item" onclick="openChat('${otherUser.id}','${otherUser.name}',event)"><div class="user-avatar">${otherUser.name.charAt(0)}</div><div style="flex:1"><div style="font-weight:600">${otherUser.name}</div><div style="font-size:0.85rem;color:var(--gray)">${chat.lastMessage}</div></div></div>`}).join('')}catch(err){console.error('Error loading chats:',err)}}async function openChat(userId,userName,clickEvent){currentChat={userId,userName};document.getElementById('chat-header').innerHTML=`<div class="user-avatar">${userName.charAt(0)}</div><span>${userName}</span>`;loadMessages(userId);document.querySelectorAll('.chat-item').forEach(item=>item.classList.remove('active'));if(clickEvent&&clickEvent.target){clickEvent.target.closest('.chat-item')?.classList.add('active')}}async function loadMessages(otherUserId){try{const response=await fetch(`${API_URL}/messages/${currentUser._id}/${otherUserId}`);const messages=await response.json();const list=document.getElementById('messages-list');list.innerHTML=messages.map(msg=>{const isSent=msg.senderId===currentUser._id;return`<div class="message ${isSent?'sent':'received'}"><div class="message-bubble"><div>${msg.text}</div><div class="message-time">${new Date(msg.createdAt).toLocaleTimeString()}</div></div></div>`}).join('');list.scrollTop=list.scrollHeight}catch(err){console.error('Error loading messages:',err)}}async function sendMessage(){const text=document.getElementById('message-text').value;if(!text||!currentChat)return;try{const response=await fetch(`${API_URL}/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({senderId:currentUser._id,receiverId:currentChat.userId,text})});if(response.ok){document.getElementById('message-text').value='';await loadMessages(currentChat.userId);await loadChats()}}catch(err){alert('Failed to send message: '+err.message)}}document.getElementById('message-text')?.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage()});async function loadProfile(){try{const[userRes,statsRes]=await Promise.all([fetch(`${API_URL}/users/${currentUser._id}`),fetch(`${API_URL}/users/${currentUser._id}/stats`)]);const stats=await statsRes.json();document.getElementById('profile-posts').textContent=stats.posts||0;document.getElementById('profile-comments').textContent=stats.comments||0;document.getElementById('profile-reactions').textContent=stats.reactions||0;const coursesRes=await fetch(`${API_URL}/courses?enrolled=${currentUser._id}`);const courses=await coursesRes.json();const coursesList=document.getElementById('profile-courses-list');coursesList.innerHTML=courses.map(course=>`<div class="mini-course-card" onclick="openCourse('${course._id}')"><strong>${course.name}</strong><div style="font-size:0.85rem;color:var(--gray);margin-top:0.25rem">${course._id}</div></div>`).join('')}catch(err){console.error('Error loading profile:',err)}}function showNewChatModal(){document.getElementById('new-chat-modal').classList.add('active');searchUsers()}function closeNewChatModal(){document.getElementById('new-chat-modal').classList.remove('active')}async function searchUsers(){const query=document.getElementById('user-search').value;try{const response=await fetch(`${API_URL}/users?search=${query}`);const users=await response.json();const list=document.getElementById('users-list');list.innerHTML=users.filter(u=>u._id!==currentUser._id).map(user=>`<div class="user-item" onclick="startChat('${user._id}','${user.name}')"><div class="user-avatar">${user.name.charAt(0)}</div><div><div style="font-weight:600">${user.name}</div><div style="font-size:0.85rem;color:var(--gray)">${user.email}</div></div></div>`).join('')}catch(err){console.error('Error searching users:',err)}}async function startChat(userId,userName){closeNewChatModal();switchView('messages');setTimeout(()=>openChat(userId,userName),300)}function showCreateCourseModal(){document.getElementById('create-course-modal').classList.add('active')}function closeCreateCourseModal(){document.getElementById('create-course-modal').classList.remove('active')}async function createCourse(){const courseId=document.getElementById('new-course-code').value.trim();const name=document.getElementById('new-course-name').value.trim();const creditHours=document.getElementById('new-course-credits').value;const description=document.getElementById('new-course-description').value.trim();const capacity=document.getElementById('new-course-capacity').value;if(!courseId||!name||!creditHours||!description||!capacity){alert('Please fill in all fields');return}try{const response=await fetch(`${API_URL}/courses`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:currentUser._id,courseId,name,creditHours,description,capacity})});if(response.ok){alert('Course created successfully!');closeCreateCourseModal();document.getElementById('new-course-code').value='';document.getElementById('new-course-name').value='';document.getElementById('new-course-credits').value='';document.getElementById('new-course-description').value='';document.getElementById('new-course-capacity').value='';loadAllCourses()}else{const error=await response.json();alert(error.error||'Failed to create course')}}catch(err){alert('Failed to create course: '+err.message)}}function showNotifications(){document.getElementById('notifications-modal').classList.add('active');document.getElementById('notification-dot').style.display='none';loadNotifications()}function closeNotifications(){document.getElementById('notifications-modal').classList.remove('active')}function showSettings(){document.getElementById('settings-modal').classList.add('active');const theme=localStorage.getItem('theme')||'light';document.getElementById('theme-selector').value=theme}function closeSettings(){document.getElementById('settings-modal').classList.remove('active')}function saveSettings(){const theme=document.getElementById('theme-selector').value;localStorage.setItem('theme',theme);applyTheme(theme);closeSettings();alert('Settings saved successfully!')}function applyTheme(theme){if(theme==='dark'){document.body.classList.add('dark-mode')}else if(theme==='light'){document.body.classList.remove('dark-mode')}else{const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;if(prefersDark){document.body.classList.add('dark-mode')}else{document.body.classList.remove('dark-mode')}}}function initTheme(){const theme=localStorage.getItem('theme')||'light';applyTheme(theme)}async function handleSearch(){const query=document.getElementById('global-search').value.trim();const resultsDiv=document.getElementById('search-results');if(!query){resultsDiv.classList.remove('active');return}try{const[coursesRes,postsRes]=await Promise.all([fetch(`${API_URL}/courses`),fetch(`${API_URL}/courses?enrolled=${currentUser._id}`).then(r=>r.json()).then(courses=>Promise.all(courses.map(c=>fetch(`${API_URL}/courses/${c._id}/posts`).then(r=>r.json())))).then(results=>results.flat())]);const courses=await coursesRes.json();const posts=postsRes;const filteredCourses=courses.filter(c=>c.name.toLowerCase().includes(query.toLowerCase())||c._id.toLowerCase().includes(query.toLowerCase())||c.description.toLowerCase().includes(query.toLowerCase()));const filteredPosts=posts.filter(p=>p.title.toLowerCase().includes(query.toLowerCase())||p.body.toLowerCase().includes(query.toLowerCase()));const results=[...filteredCourses.map(c=>({type:'course',data:c})),...filteredPosts.map(p=>({type:'post',data:p}))];if(results.length===0){resultsDiv.innerHTML='<div class="search-result-item"><div class="search-result-title">No results found</div><div class="search-result-desc">Try different keywords</div></div>';resultsDiv.classList.add('active');return}resultsDiv.innerHTML=results.slice(0,10).map(result=>{if(result.type==='course'){return`<div class="search-result-item" onclick="openCourseFromSearch('${result.data._id}')"><span class="search-result-type course">Course</span><div class="search-result-title">${result.data.name}</div><div class="search-result-desc">${result.data._id} - ${result.data.description.substring(0,80)}...</div></div>`}else{return`<div class="search-result-item" onclick="openPostFromSearch('${result.data._id}','${result.data.courseId}')"><span class="search-result-type post">Post</span><div class="search-result-title">${result.data.title}</div><div class="search-result-desc">${result.data.body.substring(0,80)}...</div></div>`}}).join('');resultsDiv.classList.add('active')}catch(err){console.error('Search error:',err)}}function hideSearchResults(){document.getElementById('search-results').classList.remove('active')}async function openCourseFromSearch(courseId){hideSearchResults();document.getElementById('global-search').value='';await openCourse(courseId)}async function openPostFromSearch(postId,courseId){hideSearchResults();document.getElementById('global-search').value='';const response=await fetch(`${API_URL}/courses/${courseId}`);currentCourse=await response.json();document.getElementById('course-title').textContent=currentCourse.name;document.getElementById('course-description').textContent=currentCourse.description;document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById('course-detail-view').classList.add('active');switchCourseTab('posts');setTimeout(()=>openPost(postId),300)}function searchTopic(topic){document.getElementById('global-search').value=topic;handleSearch()}async function loadNotifications(){try{const postsRes=await fetch(`${API_URL}/courses?enrolled=${currentUser._id}`);const courses=await postsRes.json();let allPosts=[];for(const course of courses){const response=await fetch(`${API_URL}/courses/${course._id}/posts`);const posts=await response.json();allPosts=allPosts.concat(posts.map(p=>({...p,courseName:course.name})))}const recentPosts=allPosts.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0,10);const notificationsList=document.getElementById('notifications-list');if(recentPosts.length===0){notificationsList.innerHTML='<div class="notification-item"><div class="notification-content"><div class="notification-title">No new notifications</div><div class="notification-time">Check back later</div></div></div>';return}notificationsList.innerHTML=recentPosts.map(post=>{const timeAgo=getTimeAgo(new Date(post.createdAt));const icon=post.type==='question'?'‚ùì':post.type==='announcement'?'üì¢':'üí≠';return`<div class="notification-item" onclick="openPostFromNotification('${post._id}','${post.courseId}')"><span class="notification-icon">${icon}</span><div class="notification-content"><div class="notification-title">New ${post.type} in ${post.courseName}</div><div class="notification-time">${timeAgo}</div></div></div>`}).join('');if(recentPosts.length>0){document.getElementById('notification-dot').style.display='block'}}catch(err){console.error('Error loading notifications:',err)}}function getTimeAgo(date){const seconds=Math.floor((new Date()-date)/1000);if(seconds<60)return'Just now';const minutes=Math.floor(seconds/60);if(minutes<60)return`${minutes} minute${minutes>1?'s':''} ago`;const hours=Math.floor(minutes/60);if(hours<24)return`${hours} hour${hours>1?'s':''} ago`;const days=Math.floor(hours/24);if(days<7)return`${days} day${days>1?'s':''} ago`;return date.toLocaleDateString()}async function openPostFromNotification(postId,courseId){closeNotifications();const response=await fetch(`${API_URL}/courses/${courseId}`);currentCourse=await response.json();document.getElementById('course-title').textContent=currentCourse.name;document.getElementById('course-description').textContent=currentCourse.description;document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById('course-detail-view').classList.add('active');switchCourseTab('posts');setTimeout(()=>openPost(postId),300)}